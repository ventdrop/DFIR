# GachiLoader Node.js Analysis Toolkit

A set of scripts for dynamically analysing [GachiLoader](https://research.checkpoint.com/2025/gachiloader-node-js-malware-with-api-tracing/) — a heavily obfuscated Node.js loader used to deliver Rhadamanthys and other payloads via compromised YouTube accounts.

These tools hook into the Node.js runtime to bypass anti-analysis checks, intercept decrypted payloads, and monitor native addon (`.node`) activity without needing to manually deobfuscate the malware's JavaScript source.

---

## Components

### `hook.js`

**Purpose:** Runtime environment spoofing to defeat GachiLoader's anti-analysis checks.

GachiLoader performs extensive sandbox and VM detection before executing its payload. It shells out to `tasklist`, runs PowerShell WMI queries (port connectors, disk drive models, video controllers), and checks for analysis tools in the process list. If any check fails, the malware enters a decoy loop of benign HTTP requests and never detonates.

`hook.js` intercepts these checks at the Node.js API level by hooking:

- **`child_process.spawn`** — Intercepts `tasklist` and `powershell` calls. Returns fake process listings (e.g., `chrome.exe`) and spoofed WMI results (physical hardware values like `NVIDIA GeForce RTX 3060`, `Samsung SSD 970 EVO Plus 1TB`, non-zero port connector counts) so the malware believes it is running on real hardware.
- **`Module.prototype.require`** — Monitors any attempt to load `.node` native addons (like `kidkadi.node`). Logs the caller and exported function names. If the addon fails to load (e.g., missing dependencies or wrong platform), it returns a mock object with stub functions (`init`, `start`, `connect`, `send`) so execution continues and downstream behavior can still be observed.
- **`process.dlopen`** — Logs native DLL loading attempts, providing visibility into what the malware loads at the native layer.

This script must be loaded *before* the malware sample so that all hooks are in place when the malware's code runs.

### `capture_final_payload.js`

**Purpose:** Intercept and dump decrypted payloads and buffers passed to native addons.

GachiLoader's second variant embeds an encrypted payload in its JavaScript source, decrypts it at runtime using Node's `crypto` module, and passes the resulting PE to a `.node` native addon (`kidkadi.node`) for reflective loading. This script captures that payload at two critical points:

- **`crypto.createDecipheriv` hook** — Wraps `update()` and `final()` on every decipher instance. When decryption completes, the full plaintext buffer is written to disk. The script also checks for an `MZ` header to flag PE executables.
- **`Module.prototype.require` hook** — When a `.node` addon is loaded, every exported function is wrapped. Any `Buffer` argument passed to these functions is saved to disk, capturing the exact binary blob handed off to the native loader.

All captured files are written to a configurable output directory with descriptive names (`payload_0_123456bytes.bin`, `node_input_arg_123456.bin`).

#### Usage

```
node capture_final_payload.js <hook_file> <malware_file> [options]
```

| Argument | Description |
|---|---|
| `<hook_file>` | Path to `hook.js` (loaded first to install environment spoofing) |
| `<malware_file>` | Path to the extracted GachiLoader JS module (e.g., the file extracted via `nexe_unpacker`) |
| `--timeout <seconds>` | How long to monitor before exiting (default: `120`) |
| `--outdir <directory>` | Where to write captured payloads (default: current directory) |

**Example:**

```bash
node capture_final_payload.js ./hook.js ./DNjFSUjpGTxnqNnC --timeout 180 --outdir ./captured
```

### `tracer.js` (Check Point Research)

**Purpose:** Comprehensive Node.js API tracing and hooking framework for dynamic malware analysis.

Developed by Check Point Research and [released as open source](https://github.com/CheckPointSW/Nodejs-Tracer), `tracer.js` is a more general-purpose tool that hooks a broad set of Node.js APIs — filesystem operations, network calls, `child_process`, `crypto`, and more — logging every call with arguments and return values. It also intercepts file deletions so that dropped artifacts (like `kidkadi.node` written to `%TEMP%`) are preserved for the analyst before the malware cleans up after itself.

Where `hook.js` and `capture_final_payload.js` are purpose-built for specific tasks (environment spoofing and payload extraction), `tracer.js` provides full execution visibility and is useful for initial triage of unknown or new GachiLoader variants, as well as other obfuscated Node.js malware families.

**Repository:** [github.com/CheckPointSW/Nodejs-Tracer](https://github.com/CheckPointSW/Nodejs-Tracer)

---

## How They Fit Together

A typical analysis workflow looks like this:

1. **Extract the JS source** from the packed executable using [`nexe_unpacker`](https://npm.io/package/nexe_unpacker).
2. **Triage with `tracer.js`** — Run the sample through Check Point's tracer to get a full picture of what the malware does: which anti-analysis checks it runs, what files it drops, what network calls it makes, and what C2 infrastructure it contacts. This is especially useful for new variants where behavior is unknown.
3. **Detonate with `hook.js` + `capture_final_payload.js`** — Once you understand the sample's flow, use `capture_final_payload.js` (which loads `hook.js` to bypass anti-VM checks) to extract the decrypted final payload to disk for static analysis, unpacking, or submission to a sandbox.



---

## Requirements

- **Node.js** — The malware is designed to run on Node.js. Use a version compatible with the sample (most samples bundle Node.js 18+).
- **Windows recommended** — GachiLoader targets Windows and its `.node` addons (`kidkadi.node`) are native Windows DLLs. The JS-level hooks work cross-platform, but native addon loading and full detonation require Windows.
- **Isolated environment** — Run in a VM or disposable analysis machine. Even with hooks in place, the malware may attempt privilege escalation (UAC bypass), Defender exclusion modification, and network callbacks to C2 infrastructure.

---

## References

- [GachiLoader: Defeating Node.js Malware with API Tracing](https://research.checkpoint.com/2025/gachiloader-node-js-malware-with-api-tracing/) — Check Point Research
- [Node.js Tracer](https://github.com/CheckPointSW/Nodejs-Tracer) — Check Point Research
- [Vectored Overloading PoC](https://github.com/CheckPointSW/VectoredOverloading) — Check Point Research
- [YouTube Ghost Network](https://research.checkpoint.com/2025/youtube-ghost-network/) — Check Point Research (campaign context)
- [GachiLoader pt2](https://medium.com/@rcgatenby/malware-roulette-1-gachiloader-pt2-a0ad762e03dc) - bfake 
